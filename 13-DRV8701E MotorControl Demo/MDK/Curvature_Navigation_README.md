# 基于曲率的智能路径记忆系统

## 系统概述

新的路径记忆系统采用**每隔13cm采样 + 曲率规划速度**的方案，专门为电磁循迹赛车设计：

- **采样间隔**：13cm（编码器值约74，基于170=30cm比例）
- **速度决策**：基于三点曲率计算，更精确地反映路径弯曲程度
- **内存使用**：35m赛道约270个采样点，在300点限制内安全

## 核心算法

### 1. 曲率计算
```c
float calculate_curvature(PathPoint *p1, PathPoint *p2, PathPoint *p3)
```
- 使用三点圆公式计算曲率：K = 4×Area/(a×b×c)
- 将极坐标（distance, yaw）转换为直角坐标进行计算
- 曲率值越大表示弯道越急

### 2. 速度规划
```c
float curvature_to_speed(float curvature)
```
基于曲率的速度映射：
- **曲率 < 0.001**：直道，使用speed_high (600)
- **曲率 0.001-0.005**：缓弯，使用speed_low (450) 
- **曲率 0.005-0.015**：中等弯道，使用speed_90 (350)
- **曲率 > 0.015**：急弯/环岛，使用speed_S (200)

### 3. 前瞻控制
- 前瞻3个点（约40cm距离）
- 计算前方路径的平均曲率
- 提前调整速度，避免进弯过快

## 主要优势

### 1. 精度优势
- **13cm采样**：比原来20cm更细致，能更好捕捉路径细节
- **30cm最短路段**：至少有2-3个采样点描述，完全满足需求

### 2. 曲率规划优势
- **更智能**：曲率直接反映路径弯曲程度，比角度差分更准确
- **更平滑**：避免了传统方法的速度跳跃，过渡更自然
- **更鲁棒**：对电感噪声不敏感，基于几何特征判断

### 3. 内存安全
- 35m赛道 ÷ 13cm ≈ 270个点
- 270/300 = 90%内存使用率，留有安全余量

## 使用流程

### 第一圈记录
1. 调用`refresh()`初始化系统
2. 在主循环中调用`Path_record()`
3. 每13cm自动采样一次到path_points数组
4. 检测到一圈结束后，自动调用`analyze_path_curvature()`计算所有点的曲率

### 第二圈回放  
1. 检查`flag_end == 1`确认记录完成
2. 调用`fast_tracking()`进行智能回放
3. 系统根据当前里程找到对应路径点
4. 前瞻分析前方曲率，智能设置速度

## 参数调优

### 曲率阈值调整
根据实际测试效果，可以调整速度映射的曲率阈值：
```c
// 在curvature_to_speed函数中调整这些值
if (abs_curvature < 0.001f) return speed_high;      // 直道阈值
else if (abs_curvature < 0.005f) return speed_low;  // 缓弯阈值  
else if (abs_curvature < 0.015f) return speed_90;   // 中弯阈值
```

### 前瞻距离调整
```c
uint16 lookahead_points = 3; // 可调整为2-5个点
```

## 实现要点

### 1. 一圈结束检测
你需要实现`lap_complete`的判定逻辑，建议方案：
- **磁钢检测**：检测到磁钢信号时设置`lap_complete = 1`
- **距离+角度**：回到起始位置附近且航向角相似

### 2. 编码器标定
确保`DISTANCE_RATIO = 170.0f / 30.0f`与实际编码器匹配。

### 3. 速度参数
根据车辆性能调整：
- `speed_high = 600`：直道最高速度
- `speed_low = 450`：安全巡航速度  
- `speed_90 = 350`：转弯速度
- `speed_S = 200`：急弯/环岛速度

## 预期效果

- **采样精度提升**：13cm vs 20cm，提升35%精度
- **速度控制更智能**：基于曲率的平滑控制
- **内存使用优化**：去除RDP复杂算法，直接使用原始点
- **鲁棒性增强**：对传感器噪声不敏感

这个系统应该能很好地处理你的复杂赛道（直道、钝角弯、直角弯、连续弯、环岛、十字），并在保证稳定性的前提下实现智能加速！
